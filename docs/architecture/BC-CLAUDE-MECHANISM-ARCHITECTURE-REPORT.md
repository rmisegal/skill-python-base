# BC Claude Mechanism Architecture Research Report

## Executive Summary

This report presents a comprehensive analysis of the existing Claude CLI BC (Book Creator) skills system for Hebrew-English academic LaTeX documents. Based on deep research of 8 BC skill files and the workflow documentation, we identify critical improvements needed to make the BC mechanism more **efficient, consistent, QA-compliant, token-conscious**, and **deterministic from creation**.

**Key Findings:**
- Missing critical skill: `bc-drawing` (Agent C) was referenced but never implemented (NOW FIXED)
- Content creation agents lack explicit QA-compliance rules embedded at creation time
- No validation tools to verify output before QA phase
- Heavy reliance on LLM for tasks that could be templated or Python-automated
- No centralized BC orchestration engine or progress tracking
- Inconsistent skill locations and naming conventions
- No test framework for verifying BC skill outputs

**Recommended Architecture:**
- Hybrid skill/Python tool model (matching QA architecture recommendations)
- Embedded QA-compliance rules in all BC content creation skills
- Python validation tools for pre-QA verification
- Centralized BC orchestration engine with Python backend
- Standardized test framework with unit tests for each skill
- `insert_bc_skill` meta-skill for automated skill creation and integration

---

## Table of Contents

1. [Current Architecture Analysis](#1-current-architecture-analysis)
2. [Complete Skill Hierarchy](#2-complete-skill-hierarchy)
3. [Skill Capabilities Analysis](#3-skill-capabilities-analysis)
4. [Critical Issues Identified](#4-critical-issues-identified)
5. [Skill vs Python Code Evaluation](#5-skill-vs-python-code-evaluation)
6. [Recommended Architecture](#6-recommended-architecture)
7. [insert_bc_skill Mechanism](#7-insert_bc_skill-mechanism)
8. [Python Validation Framework](#8-python-validation-framework)
9. [Protocols and Procedures](#9-protocols-and-procedures)
10. [Implementation Roadmap](#10-implementation-roadmap)
11. [Appendices](#11-appendices)

---

## 1. Current Architecture Analysis

### 1.1 Hierarchical Structure

```
Production Stages (Sequential Flow):
├── Stage 1: Project Initialization
│   └── qa-infra (setup)
│
├── Stage 2: Parallel Chapter Production (Per Chapter)
│   ├── Phase 2.1: Source Research
│   │   └── bc-source-research (Agent A - Garfield)
│   ├── Phase 2.2: Content Drafting
│   │   └── bc-Hrari-content-style (Agent B - Harari)
│   ├── Phase 2.3: Parallel Enhancement
│   │   ├── bc-code (Rami Levy)
│   │   ├── bc-math (Geoffrey Hinton)
│   │   ├── bc-drawing (Agent C - Da Vinci) [NEWLY CREATED]
│   │   └── bc-academic-source (Yoram Segal)
│   ├── Phase 2.4: Sequential Review
│   │   ├── bc-math (Hinton Review)
│   │   ├── bc-architect (Harari Review)
│   │   └── bc-hebrew (Final Polish - Academy)
│   └── Phase 2.5-2.6: QA Testing & Fixes
│       └── qa-orchestrator → qa-* skills
│
├── Stage 3: Book Integration
│   ├── bc-academic-source (global bibliography)
│   └── bc-architect (final review)
│
└── Stage 4: Publication Preparation
    ├── bc-code (GitHub preparation)
    └── qa-infra (backup)
```

### 1.2 Current Strengths

| Strength | Description |
|----------|-------------|
| Persona-based agents | Clear role separation with named personas (Harari, Hinton, Da Vinci, etc.) |
| Two-level parallelization | Inter-chapter and intra-chapter parallel execution |
| Defined workflow | Comprehensive ACADEMIC_BOOK_WORKFLOW.md with stages and phases |
| Quality gates | Clear completion signals (Source_Collection_Complete, Draft_Complete) |
| CLS command mandates | Consistent LaTeX formatting requirements documented |
| Review chain | Sequential review process (Hinton → Harari → Academy) |

### 1.3 Current Weaknesses

| Weakness | Impact | Severity |
|----------|--------|----------|
| Missing bc-drawing skill | TikZ diagrams created without BiDi rules → QA failures | CRITICAL (FIXED) |
| No embedded QA rules in BC skills | Content created incorrectly → requires QA fixes | CRITICAL |
| LLM-dependent content generation | High token consumption, inconsistent outputs | HIGH |
| No pre-QA validation | Issues only discovered after compilation | HIGH |
| Inconsistent skill locations | bc-Hrari-content-style nested under bc-math | MEDIUM |
| No test framework | No way to verify skill outputs | HIGH |
| No Python templating | Repetitive LaTeX patterns generated by LLM | MEDIUM |
| No BC orchestration engine | Manual coordination of BC agents | MEDIUM |
| No batch processing | Each chapter processed independently without coordination | MEDIUM |

---

## 2. Complete Skill Hierarchy

### 2.1 Content Creation Skills (bc-*)

| Skill | Version | Agent | Persona | Phase | Purpose |
|-------|---------|-------|---------|-------|---------|
| bc-source-research | 1.0.0 | Agent A | Eugene Garfield | 2.1 | Source collection, BibTeX preparation |
| bc-Hrari-content-style | 1.0.0 | Agent B | Yuval Noah Harari | 2.2 | Content drafting, narrative flow |
| bc-drawing | 1.0.0 | Agent C | Leonardo Da Vinci | 2.3 | TikZ diagrams, visualizations |
| bc-code | 1.0.0 | Rami Levy | Dr. Rami Levy | 2.3 | Python/NumPy code examples |
| bc-math | 1.0.0 | Hinton | Geoffrey Hinton | 2.3, 2.4 | Math verification, technical accuracy |
| bc-academic-source | 1.0.0 | Segal | Dr. Yoram Segal | 2.3, 3.2 | IEEE citations, tables, bibliography |
| bc-architect | 1.0.0 | Chief | Yuval Noah Harari | 2.4, 3.5 | Style review, narrative coherence |
| bc-hebrew | 1.0.0 | Academy | Hebrew Academy | 2.4 | Hebrew copyediting, terminology |

### 2.2 Skill Capabilities by Phase

#### Phase 2.1 - Source Research
| Skill | Capabilities | Outputs |
|-------|--------------|---------|
| bc-source-research | Search, filter, summarize sources; BibTeX prep | VSI Draft, BibTeX entries |

#### Phase 2.2 - Content Drafting
| Skill | Capabilities | Outputs |
|-------|--------------|---------|
| bc-Hrari-content-style | Narrative drafting, CLS commands, visual requests | Draft LaTeX, visual placeholders |

#### Phase 2.3 - Parallel Enhancement
| Skill | Capabilities | Outputs |
|-------|--------------|---------|
| bc-code | Python/NumPy examples, pythonbox formatting | Code blocks in LaTeX |
| bc-math | Formula verification, `\ilm{}` formatting | Verified math content |
| bc-drawing | TikZ diagrams with english wrapper | BiDi-safe figures |
| bc-academic-source | IEEE citations, RTL/LTR tables | Bibliography, tables |

#### Phase 2.4 - Sequential Review
| Skill | Review Focus | Outputs |
|-------|--------------|---------|
| bc-math | Mathematical accuracy, proofs | Technical Verification Log |
| bc-architect | Narrative flow, philosophical context | Review Log |
| bc-hebrew | Grammar, terminology, punctuation | Correction Log |

### 2.3 Skill File Locations

| Skill | Location | Issue |
|-------|----------|-------|
| bc-source-research | `.claude/skills/bc-source-research/skill.md` | OK |
| bc-Hrari-content-style | `.claude/skills/bc-math/bc-Hrari-content-style/skill.md` | **WRONG** - nested under bc-math |
| bc-drawing | `.claude/skills/bc-drawing/skill.md` | OK (newly created) |
| bc-code | `.claude/skills/bc-code/skill.md` | OK |
| bc-math | `.claude/skills/bc-math/skill.md` | OK |
| bc-academic-source | `.claude/skills/bc-academic-source/skill.md` | OK |
| bc-architect | `.claude/skills/bc-architect/skill.md` | OK |
| bc-hebrew | `.claude/skills/bc-hebrew/skill.md` | OK |

---

## 3. Skill Capabilities Analysis

### 3.1 bc-Hrari-content-style Capabilities (Content Drafting)

| Capability | Description | QA-Compliance | Can Be Templated? |
|------------|-------------|---------------|-------------------|
| Narrative drafting | Generate Harari-style prose | N/A | NO - requires LLM |
| CLS command usage | Apply `\en{}`, `\ilm{}`, etc. | YES | PARTIAL - patterns can be templated |
| Visual requests | Issue calls to bc-drawing | YES | YES - standardized format |
| Reference integration | Add `\cite{}`, `\ref{}` | YES | YES - can validate automatically |
| Section structure | Use `\hebrewsection{}` | YES | YES - can template |

**Critical Gap:** No embedded rules ensuring visual requests comply with bc-drawing requirements (English-only content).

### 3.2 bc-code Capabilities (Code Implementation)

| Capability | Description | QA-Compliance | Can Be Python? |
|------------|-------------|---------------|----------------|
| Python code generation | NumPy-focused examples | YES | NO - requires LLM |
| pythonbox formatting | `\begin{pythonbox}` env | YES | YES - can template |
| Comment language | English-only comments | YES | YES - can validate |
| Overflow detection | Simplify if too long | YES | YES - line count check |
| Pseudocode conversion | Convert to pseudocode | NO | NO - requires LLM |

**Critical Gap:** No pre-validation that code blocks are english-wrapped for BiDi safety.

### 3.3 bc-drawing Capabilities (Visual Content)

| Capability | Description | QA-Compliance | Can Be Templated? |
|------------|-------------|---------------|-------------------|
| TikZ diagram generation | Block diagrams, flowcharts | YES | PARTIAL - templates exist |
| english wrapper | `\begin{english}...\end{english}` | YES | YES - mandatory pattern |
| English-only content | No Hebrew in nodes | YES | YES - can validate |
| Hebrew captions | Caption outside english env | YES | YES - can template |

**Status:** Skill newly created with embedded QA rules. Has Python validator.

### 3.4 bc-math Capabilities (Technical Verification)

| Capability | Description | QA-Compliance | Can Be Python? |
|------------|-------------|---------------|----------------|
| Math verification | Check proofs, accuracy | NO | NO - requires expertise |
| `\ilm{}` formatting | Inline math wrapper | YES | YES - can validate/fix |
| BiDi violation detection | English in Hebrew context | YES | YES - regex patterns |
| Pedagogical assessment | Teachability check | NO | NO - requires judgment |

**Note:** bc-math already has BiDi violation detection rules (Rules 1-3) embedded.

### 3.5 bc-academic-source Capabilities (Citations & Tables)

| Capability | Description | QA-Compliance | Can Be Python? |
|------------|-------------|---------------|----------------|
| IEEE formatting | Citation format | YES | PARTIAL - templates |
| BibTeX management | Bibliography entries | YES | YES - validation |
| DOI/Link verification | Verify sources | YES | YES - URL checking |
| RTL/LTR tables | Reverse column order | YES | YES - can template |
| `\hebcell{}`, `\encell{}` | Cell formatting | YES | YES - can validate |

**Critical Gap:** Table column order reversal is documented but error-prone. Could be automated.

---

## 4. Critical Issues Identified

### 4.1 Issue #1: Missing bc-drawing Skill (FIXED)

**Status:** RESOLVED on 2025-12-22

**Problem:**
- bc-Hrari-content-style referenced "Drawing Agent (Agent C)" for visual requests
- Agent C/Da Vinci was mentioned but never implemented as a skill
- TikZ diagrams were created without BiDi rules
- Result: Reversed/mirrored diagrams in PDF output

**Evidence:**
- Line 155 in ACADEMIC_BOOK_WORKFLOW.md: "Issue calls to drawing agent for visuals"
- No `bc-drawing` skill existed in `.claude/skills/`
- QA failures due to TikZ without `\begin{english}` wrapper

**Resolution:**
- Created `bc-drawing/skill.md` with embedded QA rules
- Created `bc-drawing/validate_tikz_bidi.py` Python validator
- Updated `bc-Hrari-content-style` with visual request format
- Updated `ACADEMIC_BOOK_WORKFLOW.md` and `doc-book-from-text.md`

### 4.2 Issue #2: QA Rules Not Embedded in BC Skills

**Status:** CRITICAL - UNRESOLVED

**Problem:**
BC content creation skills generate content without embedded knowledge of what will pass QA. This creates a "generate → fail QA → fix" cycle instead of "generate correctly → pass QA" flow.

**Examples:**

| BC Skill | Missing QA Knowledge | Resulting QA Failure |
|----------|---------------------|---------------------|
| bc-code | Code blocks need `\begin{english}` wrapper | qa-code-background-detect finds overflow |
| bc-Hrari-content-style | Numbers need `\en{}` wrapper | qa-BiDi-detect Rule 6 triggers |
| bc-academic-source | Table columns must be reversed | qa-table-detect finds wrong order |
| bc-math | English terms in parentheses need `\en{}` | qa-BiDi-detect Rule 1 triggers |

**Impact:**
- Every content generation requires QA cycle
- Token waste on generate → fix iterations
- Inconsistent output quality

**Recommendation:**
Embed QA detection rules directly into BC skills as "must avoid" patterns during generation.

### 4.3 Issue #3: No Pre-QA Validation Tools

**Status:** HIGH - UNRESOLVED

**Problem:**
BC skills have no way to validate their output before passing to QA phase. Validation only happens after compilation.

**Current Flow:**
```
BC generates → Compile LaTeX → Run QA → Find issues → Fix → Recompile → Re-QA
```

**Recommended Flow:**
```
BC generates → Pre-validate (Python) → Fix before compile → Compile → QA passes
```

**Missing Tools:**

| BC Skill | Missing Validation Tool |
|----------|------------------------|
| bc-code | validate_code_bidi.py |
| bc-Hrari-content-style | validate_content_bidi.py |
| bc-academic-source | validate_tables.py |
| bc-math | validate_math_bidi.py |

### 4.4 Issue #4: Inconsistent Skill Location

**Status:** MEDIUM - UNRESOLVED

**Problem:**
`bc-Hrari-content-style` is nested under `bc-math/` directory, which is incorrect.

**Current:**
```
.claude/skills/
├── bc-math/
│   ├── skill.md
│   └── bc-Hrari-content-style/   ← WRONG LOCATION
│       └── skill.md
```

**Correct:**
```
.claude/skills/
├── bc-math/
│   └── skill.md
├── bc-Hrari-content-style/       ← CORRECT LOCATION
│   └── skill.md
```

**Impact:**
- Confusing skill discovery
- Potential issues with skill invocation
- Breaks naming convention pattern

### 4.5 Issue #5: No BC Orchestration Engine

**Status:** MEDIUM - UNRESOLVED

**Problem:**
Unlike QA which has `qa-super` and `qa-orchestrator`, there is no `bc-super` or `bc-orchestrator` to coordinate BC skills.

**Missing:**
- `bc-super` - Master BC coordinator
- `BC-TASKS.md` - BC progress tracking
- `bc_setup.json` - BC configuration

**Current Coordination:**
Manual workflow following ACADEMIC_BOOK_WORKFLOW.md with no automated orchestration.

### 4.6 Issue #6: No Test Framework

**Status:** HIGH - UNRESOLVED

**Problem:**
No unit tests exist for BC skills. Cannot verify that:
- Skills generate correct LaTeX patterns
- Skills apply CLS commands correctly
- Output is QA-compliant before running QA

**Missing:**
- Test fixtures (valid/invalid examples)
- Unit tests per skill
- Integration tests for workflow

---

## 5. Skill vs Python Code Evaluation

### 5.1 Decision Framework

```
┌─────────────────────────────────────────────────────────────────┐
│                 SKILL vs PYTHON DECISION TREE                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Is the operation creative/narrative generation?                │
│  ├─ YES → SKILL (LLM required for content creation)             │
│  └─ NO → Can it be fully specified by patterns/templates?       │
│          ├─ YES → Is it deterministic (same input = same out)?  │
│          │        ├─ YES → PYTHON TOOL (pure function)          │
│          │        └─ NO → HYBRID (skill decides, Python exec)   │
│          └─ NO → SKILL (requires judgment or creativity)        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 BC Skill Evaluation Matrix

| Skill | Keep as Skill | Convert to Python | Split (Hybrid) |
|-------|---------------|-------------------|----------------|
| bc-source-research | Source summarization | BibTeX generation, DOI validation | YES |
| bc-Hrari-content-style | Narrative writing | CLS command templating, reference validation | YES |
| bc-drawing | Diagram design decisions | Template generation, validation | YES |
| bc-code | Code logic generation | pythonbox templating, comment validation | YES |
| bc-math | Proof verification | `\ilm{}` formatting, BiDi detection | YES |
| bc-academic-source | Citation integration | IEEE formatting, table generation | YES |
| bc-architect | Style judgment | Reference completeness check | YES |
| bc-hebrew | Grammar correction | Punctuation validation | YES |

### 5.3 Capabilities to Convert to Python

#### bc-source-research → Python Tools
| Capability | Python Implementation |
|------------|----------------------|
| BibTeX entry generation | Template-based generator |
| DOI validation | HTTP request validation |
| Citation count lookup | API-based lookup |
| Duplicate detection | String matching |

#### bc-Hrari-content-style → Python Tools
| Capability | Python Implementation |
|------------|----------------------|
| CLS command validation | Regex pattern matching |
| Reference completeness check | `\ref{}` count vs figure count |
| Visual request formatting | Template generator |
| BiDi pattern detection | Same as qa-BiDi-detect |

#### bc-code → Python Tools
| Capability | Python Implementation |
|------------|----------------------|
| pythonbox template | String templating |
| Comment language validation | Regex (detect Hebrew in comments) |
| Line count check | Simple line counter |
| english wrapper check | Pattern matching |

#### bc-academic-source → Python Tools
| Capability | Python Implementation |
|------------|----------------------|
| IEEE format validation | Regex patterns |
| Table column reversal | Algorithmic reversal |
| Cell command validation | Pattern matching |
| DOI/Link verification | HTTP HEAD requests |

### 5.4 Token Savings Projection

| Operation Type | Current (LLM) | With Python | Savings |
|----------------|---------------|-------------|---------|
| BibTeX generation (per entry) | ~200 tokens | 0 tokens | 100% |
| Table column reversal | ~500 tokens | 0 tokens | 100% |
| CLS command templating | ~100 tokens | 0 tokens | 100% |
| Validation checks | ~300 tokens | 0 tokens | 100% |
| pythonbox templating | ~150 tokens | 0 tokens | 100% |
| Content generation (per chapter) | ~5000 tokens | ~5000 tokens | 0% |

**Estimated total savings: 30-40% token reduction for BC operations**

---

## 6. Recommended Architecture

### 6.1 New Hybrid BC Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        BC ORCHESTRATION ENGINE                           │
│                     (Python Backend + Skill Frontend)                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                     bc_setup.json (Configuration)                 │   │
│  │  {                                                                │   │
│  │    "enabled_skills": ["source-research", "content", "code"...],  │   │
│  │    "execution_order": ["source-research", "content", "enhance"], │   │
│  │    "parallel_enhancement": true,                                  │   │
│  │    "pre_validation": true,                                        │   │
│  │    "qa_compliance_check": true,                                   │   │
│  │    "template_mode": "hybrid"                                      │   │
│  │  }                                                                │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌────────────────────┐  ┌────────────────────┐  ┌─────────────────┐   │
│  │   BC Controller    │  │   Progress Monitor │  │  Template Gen   │   │
│  │   (Python)         │  │   (Python)         │  │  (Python)       │   │
│  │                    │  │                    │  │                 │   │
│  │ - Load config      │  │ - Track stages     │  │ - LaTeX temps   │   │
│  │ - Dispatch skills  │  │ - Chapter progress │  │ - BibTeX gen    │   │
│  │ - Pre-validate     │  │ - Signal handling  │  │ - Table gen     │   │
│  │ - Coordinate       │  │ - Log events       │  │ - Code blocks   │   │
│  └─────────┬──────────┘  └─────────┬──────────┘  └────────┬────────┘   │
│            │                       │                       │            │
│  ┌─────────┴───────────────────────┴───────────────────────┴─────────┐  │
│  │                      SHARED STATE MANAGER                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │  │
│  │  │ Chapter     │  │ Signal      │  │ Status DB   │                │  │
│  │  │ Locks       │  │ Queue       │  │ (JSON)      │                │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
          ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
          │Python Tools │  │Python Tools │  │Python Tools │
          │(Templates)  │  │(Validation) │  │(Generation) │
          └─────────────┘  └─────────────┘  └─────────────┘
                    │               │               │
                    ▼               ▼               ▼
          ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
          │ Claude Skill│  │ Claude Skill│  │ Claude Skill│
          │ (Creative)  │  │ (Review)    │  │ (Polish)    │
          └─────────────┘  └─────────────┘  └─────────────┘
```

### 6.2 Embedded QA Rules Model

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    QA-COMPLIANT BC SKILL MODEL                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (Current):                                                       │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│  │ BC Skill     │ ──► │ Compile      │ ──► │ QA Detect    │            │
│  │ (generates)  │     │ (PDF)        │     │ (finds bugs) │            │
│  └──────────────┘     └──────────────┘     └──────────────┘            │
│         │                                          │                    │
│         └──────────── Fix Loop ◄───────────────────┘                    │
│                                                                          │
│  AFTER (Recommended):                                                    │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│  │ BC Skill     │ ──► │ Pre-Validate │ ──► │ Compile      │            │
│  │ (generates   │     │ (Python)     │     │ (PDF)        │            │
│  │  with QA     │     │              │     │              │            │
│  │  rules)      │     └──────────────┘     └──────────────┘            │
│  └──────────────┘            │                    │                    │
│         ▲                    │                    ▼                    │
│         │                    │             ┌──────────────┐            │
│         └─── Fix Before ◄────┘             │ QA Verify    │            │
│              Compile                       │ (usually     │            │
│                                            │  PASS)       │            │
│                                            └──────────────┘            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.3 BC Skill Template with Embedded QA Rules

```markdown
---
name: bc-{skill-name}
description: {Description} with embedded QA compliance rules
version: 2.0.0
qa_rules_embedded: true
---

# {Skill Name}

## QA Compliance Rules (MUST FOLLOW)

### From qa-BiDi Family:
- Rule 6: ALL numbers in Hebrew context MUST use `\en{}` or `\num{}`
- Rule 7: ALL English text in Hebrew context MUST use `\en{}`
- Rule 8: ALL tcolorbox/code blocks MUST be wrapped in `\begin{english}`
- Rule 10: ALL acronyms MUST use `\en{}`

### From qa-code Family:
- ALL code blocks MUST use `\begin{pythonbox}` or `\begin{pythonbox*}`
- ALL comments in code MUST be English only
- Code blocks MUST be wrapped in `\begin{english}` for BiDi safety

### From qa-img Family:
- ALL figures MUST be referenced in body text
- ALL TikZ MUST be wrapped in `\begin{english}`
- ALL diagram text MUST be English only

## Pre-Validation Checklist

Before outputting content, verify:
- [ ] Numbers wrapped: `\en{123}` or `\num{123}`
- [ ] English wrapped: `\en{term}`
- [ ] Code wrapped: `\begin{english}\begin{pythonbox}...\end{pythonbox}\end{english}`
- [ ] TikZ wrapped: `\begin{english}\begin{tikzpicture}...\end{tikzpicture}\end{english}`
- [ ] All references present: `איור~\ref{fig:...}`

## Python Validation Tool

Use `validate_{skill}.py` before completion:
```bash
python validate_{skill}.py chapter_N.tex
```
Must return PASS before signaling completion.
```

---

## 7. insert_bc_skill Mechanism

### 7.1 Overview

The `insert_bc_skill` is a meta-skill that automates the creation and integration of new BC skills. It mirrors the `insert_qa_skill` concept for the BC mechanism.

### 7.2 insert_bc_skill Skill Definition

```yaml
# .claude/skills/insert_bc_skill/skill.md
---
name: insert_bc_skill
description: Creates and integrates new BC skills with embedded QA rules and Python validation
version: 1.0.0
author: BC Team
tags: [bc, meta-skill, skill-creation, python-tool, integration]
tools: [Read, Write, Edit, Grep, Glob, Bash, Task]
---
```

### 7.3 Operating Modes

```
Mode 1: Create New BC Skill
invoke: insert_bc_skill --mode=create
arguments:
  --name: skill name (e.g., bc-new-creator)
  --phase: workflow phase (2.1, 2.2, 2.3, 2.4)
  --persona: agent persona name
  --description: brief description
  --qa_rules: comma-separated QA rules to embed
  --python: true | false (generate Python validation tool)

Mode 2: Add QA Rules to Existing Skill
invoke: insert_bc_skill --mode=embed-qa
arguments:
  --skill: existing skill name
  --qa_rules: comma-separated QA rules to add

Mode 3: Generate Python Validator
invoke: insert_bc_skill --mode=add-validator
arguments:
  --skill: existing skill name
  --validations: comma-separated validation types
```

### 7.4 Generated File Structure

```
.claude/skills/{bc-skill-name}/
├── skill.md                 # Skill definition with QA rules
├── validate_{skill}.py      # Python pre-validation tool
├── test_validate.py         # Unit tests for validator
├── templates/               # LaTeX templates (if applicable)
│   ├── section.tex
│   ├── figure.tex
│   └── table.tex
└── fixtures/                # Test fixtures
    ├── valid_output.tex
    └── invalid_output.tex
```

---

## 8. Python Validation Framework

### 8.1 Pre-Validation Tool Structure

```python
# bc_engine/validators/base_validator.py

from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import List, Dict, Optional
import re

@dataclass
class ValidationIssue:
    """Issue found during pre-validation."""
    rule: str
    file: str
    line: int
    content: str
    severity: str  # WARNING, ERROR
    fix_suggestion: str

class BCValidator(ABC):
    """Base class for BC skill validators."""

    @abstractmethod
    def validate(self, content: str, file_path: str) -> List[ValidationIssue]:
        """Validate content and return list of issues."""
        pass

    @abstractmethod
    def get_rules(self) -> Dict[str, str]:
        """Return dict of rule_name -> description."""
        pass
```

### 8.2 Content Validator Implementation

```python
# bc_engine/validators/validate_content.py

import re
from base_validator import BCValidator, ValidationIssue

class ContentValidator(BCValidator):
    """Validate bc-Hrari-content-style output for QA compliance."""

    def __init__(self):
        self.rules = {
            'number-not-wrapped': r'(?<![\\]en\{)(?<![\\]num\{)\b(\d+\.?\d*)\b(?![}\d])',
            'english-not-wrapped': r'(?<![\\]en\{)[A-Z][a-z]{2,}(?!\})',
            'acronym-not-wrapped': r'(?<![\\]en\{)[A-Z]{2,}(?!\})',
            'tikz-no-english': r'\\begin\{tikzpicture\}(?!.*\\begin\{english\})',
            'missing-figure-ref': r'\\begin\{figure\}.*?\\label\{(fig:[^}]+)\}',
        }

    def validate(self, content: str, file_path: str) -> list:
        issues = []
        lines = content.split('\n')

        # Check for Hebrew context (contains Hebrew chars)
        for i, line in enumerate(lines, 1):
            if self._contains_hebrew(line):
                # Check Rule 6: Numbers
                for match in re.finditer(self.rules['number-not-wrapped'], line):
                    issues.append(ValidationIssue(
                        rule='number-not-wrapped',
                        file=file_path,
                        line=i,
                        content=line.strip()[:60],
                        severity='ERROR',
                        fix_suggestion=f'Wrap with \\en{{{match.group(1)}}}'
                    ))

                # Check Rule 7: English text
                for match in re.finditer(self.rules['english-not-wrapped'], line):
                    issues.append(ValidationIssue(
                        rule='english-not-wrapped',
                        file=file_path,
                        line=i,
                        content=line.strip()[:60],
                        severity='ERROR',
                        fix_suggestion=f'Wrap with \\en{{{match.group(0)}}}'
                    ))

        return issues

    def _contains_hebrew(self, text: str) -> bool:
        return bool(re.search(r'[\u0590-\u05FF]', text))

    def get_rules(self) -> dict:
        return {
            'number-not-wrapped': 'Numbers in Hebrew context must use \\en{} or \\num{}',
            'english-not-wrapped': 'English text in Hebrew context must use \\en{}',
            'acronym-not-wrapped': 'Acronyms in Hebrew context must use \\en{}',
            'tikz-no-english': 'TikZ must be wrapped in \\begin{english}',
            'missing-figure-ref': 'All figures must be referenced in body text',
        }
```

### 8.3 Code Validator Implementation

```python
# bc_engine/validators/validate_code.py

import re
from base_validator import BCValidator, ValidationIssue

class CodeValidator(BCValidator):
    """Validate bc-code output for QA compliance."""

    def validate(self, content: str, file_path: str) -> list:
        issues = []

        # Find all pythonbox environments
        pythonbox_pattern = r'\\begin\{pythonbox\*?\}(.*?)\\end\{pythonbox\*?\}'

        for match in re.finditer(pythonbox_pattern, content, re.DOTALL):
            code_content = match.group(1)
            start_pos = match.start()
            line_num = content[:start_pos].count('\n') + 1

            # Check for Hebrew in comments
            comment_pattern = r'#.*[\u0590-\u05FF]'
            if re.search(comment_pattern, code_content):
                issues.append(ValidationIssue(
                    rule='hebrew-in-comment',
                    file=file_path,
                    line=line_num,
                    content='Hebrew found in code comment',
                    severity='ERROR',
                    fix_suggestion='All comments must be in English'
                ))

            # Check for english wrapper
            before_pythonbox = content[max(0, start_pos-50):start_pos]
            if '\\begin{english}' not in before_pythonbox:
                issues.append(ValidationIssue(
                    rule='code-no-english-wrapper',
                    file=file_path,
                    line=line_num,
                    content='pythonbox not wrapped in english environment',
                    severity='WARNING',
                    fix_suggestion='Wrap pythonbox in \\begin{english}...\\end{english}'
                ))

            # Check line count
            line_count = code_content.count('\n')
            if line_count > 40:
                issues.append(ValidationIssue(
                    rule='code-too-long',
                    file=file_path,
                    line=line_num,
                    content=f'Code block has {line_count} lines',
                    severity='WARNING',
                    fix_suggestion='Consider simplifying or using pythonbox*'
                ))

        return issues

    def get_rules(self) -> dict:
        return {
            'hebrew-in-comment': 'Code comments must be English only',
            'code-no-english-wrapper': 'Code blocks should be wrapped in english env',
            'code-too-long': 'Code blocks should be under 40 lines',
        }
```

### 8.4 Test Framework

```python
# bc_engine/tests/test_validators.py

import unittest
from validators.validate_content import ContentValidator
from validators.validate_code import CodeValidator

class TestContentValidator(unittest.TestCase):
    def setUp(self):
        self.validator = ContentValidator()

    def test_detects_unwrapped_number(self):
        content = "גרסה 0.5 של המערכת"
        issues = self.validator.validate(content, "test.tex")
        self.assertEqual(len(issues), 1)
        self.assertEqual(issues[0].rule, 'number-not-wrapped')

    def test_allows_wrapped_number(self):
        content = r"גרסה \en{0.5} של המערכת"
        issues = self.validator.validate(content, "test.tex")
        self.assertEqual(len(issues), 0)

    def test_detects_unwrapped_english(self):
        content = "פרוטוקול MCP לליגת סוכנים"
        issues = self.validator.validate(content, "test.tex")
        self.assertTrue(any(i.rule == 'acronym-not-wrapped' for i in issues))


class TestCodeValidator(unittest.TestCase):
    def setUp(self):
        self.validator = CodeValidator()

    def test_detects_hebrew_comment(self):
        content = r"""
\begin{pythonbox}
# זהו קוד פייתון
def foo():
    pass
\end{pythonbox}
"""
        issues = self.validator.validate(content, "test.tex")
        self.assertTrue(any(i.rule == 'hebrew-in-comment' for i in issues))

    def test_allows_english_comment(self):
        content = r"""
\begin{english}
\begin{pythonbox}
# This is Python code
def foo():
    pass
\end{pythonbox}
\end{english}
"""
        issues = self.validator.validate(content, "test.tex")
        self.assertFalse(any(i.rule == 'hebrew-in-comment' for i in issues))


if __name__ == '__main__':
    unittest.main()
```

---

## 9. Protocols and Procedures

### 9.1 Protocol: Adding Embedded QA Rules to BC Skill

```
┌─────────────────────────────────────────────────────────────────┐
│     PROTOCOL: ADDING EMBEDDED QA RULES TO BC SKILL               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  STEP 1: IDENTIFY RELEVANT QA RULES                              │
│  ─────────────────────────────────────                           │
│  □ Review qa-BiDi-detect rules                                   │
│  □ Review qa-code-detect rules                                   │
│  □ Review qa-table-detect rules                                  │
│  □ Review qa-img-detect rules                                    │
│  □ List rules that apply to this BC skill's output               │
│                                                                  │
│  STEP 2: DOCUMENT RULES IN SKILL                                 │
│  ─────────────────────────────────                               │
│  □ Add "## QA Compliance Rules (MUST FOLLOW)" section            │
│  □ List each rule with pattern to AVOID                          │
│  □ Provide correct pattern to USE                                │
│  □ Add examples of wrong vs. right                               │
│                                                                  │
│  STEP 3: ADD PRE-VALIDATION CHECKLIST                            │
│  ──────────────────────────────────────                          │
│  □ Add "## Pre-Validation Checklist" section                     │
│  □ List checkboxes for each rule                                 │
│  □ Require all checks before completion signal                   │
│                                                                  │
│  STEP 4: CREATE PYTHON VALIDATOR                                 │
│  ─────────────────────────────────                               │
│  □ Create validate_{skill}.py                                    │
│  □ Implement detection for each rule                             │
│  □ Return PASS/FAIL with issue details                           │
│                                                                  │
│  STEP 5: ADD TEST FIXTURES                                       │
│  ─────────────────────────                                       │
│  □ Create valid_output.tex (passes all rules)                    │
│  □ Create invalid_output.tex (violates rules)                    │
│  □ Write unit tests                                              │
│                                                                  │
│  STEP 6: UPDATE VERSION                                          │
│  ─────────────────────────                                       │
│  □ Increment skill version                                       │
│  □ Add version history entry:                                    │
│    "Embedded QA rules from qa-* families"                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Protocol: Creating New BC Skill

```
┌─────────────────────────────────────────────────────────────────┐
│           PROTOCOL: CREATING NEW BC SKILL                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  STEP 1: REQUIREMENTS GATHERING                                  │
│  ─────────────────────────────────                               │
│  □ Define content type this skill creates                        │
│  □ Identify workflow phase (2.1, 2.2, 2.3, 2.4)                 │
│  □ Choose persona (existing or new)                              │
│  □ List inputs and outputs                                       │
│  □ Identify which QA rules apply                                 │
│                                                                  │
│  STEP 2: USE insert_bc_skill                                     │
│  ──────────────────────────────                                  │
│  □ Invoke: Skill: insert_bc_skill                                │
│  □ Provide arguments:                                            │
│    --mode=create                                                 │
│    --name={bc-skill-name}                                        │
│    --phase={phase}                                               │
│    --persona={persona}                                           │
│    --description={brief description}                             │
│    --qa_rules={comma-separated rules}                            │
│    --python=true                                                 │
│                                                                  │
│  STEP 3: REVIEW AND CUSTOMIZE                                    │
│  ─────────────────────────────                                   │
│  □ Review generated skill.md                                     │
│  □ Add domain-specific rules                                     │
│  □ Customize templates if needed                                 │
│  □ Add persona-specific instructions                             │
│                                                                  │
│  STEP 4: UPDATE WORKFLOW                                         │
│  ─────────────────────────                                       │
│  □ Add skill to ACADEMIC_BOOK_WORKFLOW.md                        │
│  □ Update phase execution diagram                                │
│  □ Add to doc-book-from-text.md                                  │
│                                                                  │
│  STEP 5: TEST                                                    │
│  ───────────                                                     │
│  □ Run validator tests                                           │
│  □ Generate sample content                                       │
│  □ Verify QA compliance                                          │
│  □ Test with real chapter                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.3 bc_setup.json Configuration Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "BC Setup Configuration",
  "description": "Configuration for BC orchestration system",
  "type": "object",
  "properties": {
    "enabled_skills": {
      "type": "array",
      "description": "List of BC skills to enable",
      "items": {
        "type": "string",
        "enum": ["source-research", "content", "drawing", "code", "math",
                 "academic-source", "architect", "hebrew"]
      },
      "default": ["source-research", "content", "code", "math", "academic-source"]
    },
    "workflow_phases": {
      "type": "object",
      "properties": {
        "2.1": {"type": "array", "items": {"type": "string"}},
        "2.2": {"type": "array", "items": {"type": "string"}},
        "2.3": {"type": "array", "items": {"type": "string"}},
        "2.4": {"type": "array", "items": {"type": "string"}}
      }
    },
    "parallel_enhancement": {
      "type": "boolean",
      "description": "Run Phase 2.3 skills in parallel",
      "default": true
    },
    "pre_validation": {
      "type": "object",
      "properties": {
        "enabled": {"type": "boolean", "default": true},
        "strict_mode": {"type": "boolean", "default": false},
        "validators": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "qa_compliance_check": {
      "type": "boolean",
      "description": "Run QA compliance check before signaling completion",
      "default": true
    },
    "template_mode": {
      "type": "string",
      "enum": ["llm_only", "template_first", "hybrid"],
      "default": "hybrid"
    },
    "logging": {
      "type": "object",
      "properties": {
        "level": {"type": "string", "default": "INFO"},
        "file_enabled": {"type": "boolean", "default": true}
      }
    }
  }
}
```

---

## 10. Implementation Roadmap

### Phase 1: Critical Fixes (Immediate)

| Task | Priority | Effort | Status |
|------|----------|--------|--------|
| Create bc-drawing skill | CRITICAL | Done | COMPLETED |
| Fix bc-Hrari-content-style location | MEDIUM | 1 hour | PENDING |
| Add QA rules to bc-code | HIGH | 2 hours | PENDING |
| Add QA rules to bc-Hrari-content-style | HIGH | 2 hours | PENDING |

### Phase 2: Python Validation Tools

| Task | Priority | Effort | Status |
|------|----------|--------|--------|
| Create base_validator.py | HIGH | 2 hours | PENDING |
| Create validate_content.py | HIGH | 3 hours | PENDING |
| Create validate_code.py | HIGH | 2 hours | PENDING |
| Create validate_tikz_bidi.py | HIGH | Done | COMPLETED |
| Create validate_tables.py | MEDIUM | 2 hours | PENDING |
| Create test framework | HIGH | 3 hours | PENDING |

### Phase 3: Embedded QA Rules

| Task | Priority | Effort | Status |
|------|----------|--------|--------|
| Embed QA rules in bc-Hrari-content-style | HIGH | 2 hours | PENDING |
| Embed QA rules in bc-code | HIGH | 2 hours | PENDING |
| Embed QA rules in bc-academic-source | HIGH | 2 hours | PENDING |
| Embed QA rules in bc-math | MEDIUM | 1 hour | PARTIAL |
| Create rule reference document | MEDIUM | 2 hours | PENDING |

### Phase 4: BC Orchestration Engine

| Task | Priority | Effort | Status |
|------|----------|--------|--------|
| Create bc_setup.json schema | MEDIUM | 1 hour | PENDING |
| Create BC controller | MEDIUM | 4 hours | PENDING |
| Create progress tracker | MEDIUM | 2 hours | PENDING |
| Create signal handler | MEDIUM | 2 hours | PENDING |
| Integrate with ACADEMIC_BOOK_WORKFLOW | MEDIUM | 2 hours | PENDING |

### Phase 5: insert_bc_skill Meta-Skill

| Task | Priority | Effort | Status |
|------|----------|--------|--------|
| Create insert_bc_skill skill.md | MEDIUM | 3 hours | PENDING |
| Implement create mode | MEDIUM | 3 hours | PENDING |
| Implement embed-qa mode | MEDIUM | 2 hours | PENDING |
| Implement add-validator mode | MEDIUM | 2 hours | PENDING |
| Create skill templates | MEDIUM | 2 hours | PENDING |

---

## 11. Appendices

### Appendix A: Complete BC File Structure (Recommended)

```
.claude/
├── skills/
│   ├── bc-source-research/
│   │   ├── skill.md
│   │   ├── validate_sources.py
│   │   └── templates/
│   │       └── bibtex_entry.template
│   │
│   ├── bc-Hrari-content-style/     # MOVED from bc-math/
│   │   ├── skill.md
│   │   ├── validate_content.py
│   │   └── templates/
│   │       ├── section.template
│   │       ├── figure_ref.template
│   │       └── visual_request.template
│   │
│   ├── bc-drawing/
│   │   ├── skill.md
│   │   ├── validate_tikz_bidi.py
│   │   └── templates/
│   │       ├── block_diagram.template
│   │       ├── flowchart.template
│   │       └── architecture.template
│   │
│   ├── bc-code/
│   │   ├── skill.md
│   │   ├── validate_code.py
│   │   └── templates/
│   │       ├── pythonbox.template
│   │       └── pythonbox_star.template
│   │
│   ├── bc-math/
│   │   ├── skill.md
│   │   └── validate_math.py
│   │
│   ├── bc-academic-source/
│   │   ├── skill.md
│   │   ├── validate_citations.py
│   │   ├── validate_tables.py
│   │   └── templates/
│   │       ├── rtl_table.template
│   │       └── ieee_citation.template
│   │
│   ├── bc-architect/
│   │   └── skill.md
│   │
│   ├── bc-hebrew/
│   │   └── skill.md
│   │
│   ├── insert_bc_skill/
│   │   ├── skill.md
│   │   └── templates/
│   │
│   └── bc-orchestration/
│       ├── BC-CLAUDE.md
│       ├── BC-TASKS.md
│       └── bc_setup.json
│
├── bc_engine/                    # NEW: Python backend
│   ├── __init__.py
│   ├── controller.py
│   ├── progress_tracker.py
│   ├── signal_handler.py
│   ├── validators/
│   │   ├── __init__.py
│   │   ├── base_validator.py
│   │   ├── validate_content.py
│   │   ├── validate_code.py
│   │   ├── validate_tikz.py
│   │   └── validate_tables.py
│   └── templates/
│       └── template_engine.py
│
└── commands/
    ├── doc-book-from-text.md
    └── full-pdf-qa.md
```

### Appendix B: QA Rules to Embed in Each BC Skill

| BC Skill | QA Rules to Embed |
|----------|-------------------|
| bc-Hrari-content-style | BiDi Rules 6, 7, 10, 12, 15; Figure reference completeness |
| bc-code | Code background detection; English-only comments; Line limit |
| bc-drawing | TikZ english wrapper; English-only content; Caption placement |
| bc-math | BiDi Rules 1, 2, 3; `\ilm{}` formatting |
| bc-academic-source | Table column reversal; Cell command usage; DOI validation |

### Appendix C: Signal Definitions

| Signal | Source | Trigger | Next Phase |
|--------|--------|---------|------------|
| Source_Collection_Complete | bc-source-research | ≥30 sources per chapter | Phase 2.2 |
| Draft_Complete | bc-Hrari-content-style | Chapter draft finished | Phase 2.3 |
| Enhancement_Complete | bc-code, bc-math, bc-drawing, bc-academic-source | All 4 agents done | Phase 2.4 |
| Hinton_Review_Complete | bc-math | Technical review done | Harari Review |
| Harari_Review_Complete | bc-architect | Style review done | Hebrew Polish |
| Polish_Complete | bc-hebrew | Linguistic review done | Compilation |
| QA_PASS | qa-orchestrator | All QA agents pass | Stage 3 |

### Appendix D: Token Savings Summary

| Operation | Tokens Before | Tokens After | Savings |
|-----------|---------------|--------------|---------|
| BibTeX entry generation | 200/entry | 0 | 100% |
| Table column reversal | 500/table | 0 | 100% |
| pythonbox templating | 150/block | 0 | 100% |
| CLS command insertion | 100/command | 0 | 100% |
| Pre-validation checks | 300/check | 0 | 100% |
| TikZ template | 400/diagram | 100 | 75% |
| **Average per chapter** | ~8000 | ~5000 | **37.5%** |

---

## Conclusion

This research report provides a comprehensive analysis of the existing BC Claude mechanism and presents a detailed architecture for improvement. The key recommendations are:

1. **Fix skill locations** - Move bc-Hrari-content-style to correct directory
2. **Embed QA rules** - Add QA compliance rules to all BC content creation skills
3. **Create Python validators** - Pre-validation tools for each BC skill
4. **Adopt hybrid model** - Use Python for templating/validation, LLM for creative content
5. **Build BC orchestration engine** - Centralized coordination with Python backend
6. **Create insert_bc_skill** - Automate BC skill creation and integration
7. **Build test framework** - Unit tests for all validators with fixtures

The estimated token savings from Python migration and pre-validation is 30-40%, with improved QA pass rates due to content being generated correctly from the start.

**Critical Priority:** Embed QA rules into BC skills so content is generated QA-compliant from creation, eliminating the generate → fail QA → fix cycle.

---

*Report generated: 2025-12-22*
*Author: Claude Code BC Research*
*Version: 1.0.0*
